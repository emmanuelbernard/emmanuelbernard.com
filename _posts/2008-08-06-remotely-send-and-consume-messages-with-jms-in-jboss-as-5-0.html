---
title: 'Remotely send and consume messages with JMS in JBoss AS 5.0'
author: 'Emmanuel Bernard'
tags: [ jboss ]
date: 2008-08-06
---
<p>This tutorial will show you how to create a queue in JBoss AS 5 (which uses JBoss Messaging 1.4.1), send a message to a remote queue and listen to the queue using a Message Driven Bean.</p><p>I have been playing with JMS queues and MDBs in JBoss AS 5 today to complete the clustering chapter of <a href='http://www.manning.com/affiliate/idevaffiliate.php?id=952_117_1_24'>Hibernate Search in Action</a> and went through more bumps than I should have. Let me share what I've learnt. Disclaimer, I am a JMS noob: this tutorial will go only over the basic concepts. In particular, I will not cover subjects like security, message persistence and so on. This tutorial can be partly reused by Hibernate Search users using clustering (just ignore the part when we send and consume messages as Hibernate Search does that under the hood).</p><p>First of all, get a fresh version of JBoss AS 5.0 (currently in Release Candidate 1) <a href='http://www.jboss.org/jbossas/downloads/'>here</a>. We will launch two instances of JBoss AS in parallel. If you are lucky enough, run them in two different machines (virtual image or not). If you are not, you will have to remap a few ports to avoid any conflict and this is what I will just describe now.</p><p>Go to <em>JBOSS_HOME/serve</em><em>r</em> and copy the <em>default</em> directory as <em>master</em>.</p><blockquote>  <p>cp -r default master</p></blockquote><p>We now have two versions of the JBoss configuration. <em>default</em> will contain our slave instance configuration and <em>master</em> will contain our master instance configuration. Let's now change the default ports on the <em>master</em> configuration. In the master directory, open each file described and change the following ports</p><ul>  <li><em>conf/jboss-service.xml</em> from port 1099 to 1199 (JNDI)</li>  <li><em>conf/jboss-service.xml</em> from port 8083 to 8084 (WebServices)</li>  <li><em>conf/jboss-service.xml</em> from port 1098 to 1097 (RMI)</li>  <li><em>conf/jboss-service.xml</em> from port 4446 to 4447 (Remoting)</li>  <li><em>deploy/ejb3-connectors-service.xml</em> from port 3873 to 3874</li>  <li><em>deploy/jbossweb.sar/server.xml</em> from 8080 to 8081 (HTTP)</li>  <li><em>deploy/jbossweb.sar/server.xml</em> from 8009 to 8010 (Apache connector)</li>  <li><em>deploy/http-invoker.sar/META-INF/jboss-service.xml</em> from port 8080 to 8081</li>  <li><em>deploy/jmx-remoting.sar/META-INF/jboss-service.xml</em> from port 1090 to 1091</li>  <li><em>deploy/messaging/remoting-bisocket-service.xml</em> from port 4457 to 4458</li>  <li><em>deploy/remoting-service.xml</em> from port 4444 to 4443</li>  <li><em>deploy/remoting-service.xml</em> from port 4445 to 4442</li></ul><p>This step is only required if you use the same server to run both instances. There is an alternative and more elegant approach described <a href='http://wiki.jboss.org/wiki/ConfiguringMultipleJBossInstancesOnOneMachine'>here</a> (thanks <a href='http://twitter.com/julienviet/'>Julien</a> for tweeting me the answer after I did all the hard work :) )</p><p>You need to make sure JBoss Messaging has a different <em>ServerPeerID</em> between different instances. Update <em>deploy/messaging/messaging-service.xml<span style='font-style: normal;'>, and set</span> ServerPeerID <span style='font-style: normal;'>to 1 (the</span> default <span style='font-style: normal;'>configuration uses 0)</span></em></p><p>We will now create the queue in the master instance. Open <em>deploy/messaging/destinations-service.xml<span style='font-style: normal;'>, and add the following fragment</span></em></p><blockquote>  <p><span class='Apple-style-span' style='color: rgb(42, 0, 255);   font-family:Monaco;font-size:11px;'><span><span class='Apple-style-span' style='color: rgb(0, 128, 128);'>&lt;</span></span><span style='color:#3f7f7f;'>mbean </span><span style='color:#7f007f;'>code</span><span style='color:#000000;'>=</span>"org.jboss.jms.server.destination.QueueService"</span></p> <p style='margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco; color:#2a00ff;'>      <span style='color:#7f007f;'>name</span><span style='color:#000000;'>=</span>"jboss.messaging.destination:service=Queue,name=hibernatesearch"</p> <p style='margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco; color:#2a00ff;'>      <span style='color:#7f007f;'>xmbean-dd</span><span style='color:#000000;'>=</span>"xmdesc/Queue-xmbean.xml"&gt;</p> <p style='margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco'>      <span class='Apple-style-span' style='color: rgb(0, 128, 128);'>&lt;</span><span style='color:#3f7f7f;'>depends </span><span style='color:#7f007f;'>optional-attribute-name</span>=<span style='color:#2a00ff;'>"ServerPeer"</span><span><span class='Apple-style-span' style='color: rgb(0, 128, 128);'>&gt;</span></span>jboss.messaging:service=ServerPeer&lt;/<span style='color:#008080;'/><span style='color:#3f7f7f;'>depends</span><span><span class='Apple-style-span' style='color: rgb(0, 128, 128);'>&gt;</span></span></p> <p style='margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco'>      <span class='Apple-style-span' style='color: rgb(0, 128, 128);'>&lt;</span><span style='color:#3f7f7f;'>depends</span><span><span class='Apple-style-span' style='color: rgb(0, 128, 128);'>&gt;</span></span>jboss.messaging:service=PostOffice&lt;/<span style='color:#008080;'/><span style='color:#3f7f7f;'>depends&amp;</span><span><span class='Apple-style-span' style='color: rgb(0, 128, 128);'>gt;</span></span></p><p style='margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco'><span style='color:#008080;'><span class='Apple-style-span' style='color: rgb(63, 127, 127); '>&lt;/mbean</span><span class='Apple-style-span' style=''>&gt;</span></span></p></blockquote><p>A queue is an MBean object, you can refine it's configuration as explained in the <a href='http://www.jboss.org/file-access/default/members/jbossmessaging/freezone/docs/userguide-1.4.1.Beta1/html_single/index.html#conf.destination.queue'>JBoss Messaging documentation</a>. As a start, you can simply copy the fragment and replace <strong>hibernatesearch</strong> by the name of your queue. The queue will be available in JNDI under <em>queue/hibernatesearch</em> (this can be overridden if needed). If you start the master instance of JBoss AS (go to <em>JBOSS_HOME/bin</em> and launch <em>./run.sh -c master</em>), you should see the following lines in the console</p><blockquote>  <p>19:27:46,403 INFO [QueueService] Queue[/queue/hibernatesearch] started, fullSize=200000, pageSize=2000, downCacheSize=2000</p></blockquote>The next step is to publish a message from the default JBoss AS instance into the queue. Here is a simple servlet doing so:<blockquote>  <p style='font: 11.0px Monaco'><span style='color:#7f0055;'><span style=' white-space: pre;color:#000000;'><span style=' white-space: normal;color:#646464;'>@Override</span></span></span></p>  <p style='font: 11.0px Monaco'><span style='color:#7f0055;'>public</span> <span style='color:#7f0055;'>void</span> doGet(HttpServletRequest request, HttpServletResponse response)</p>  <p style='font: 11.0px Monaco'><span style='color:#7f0055;'>    throws</span> ServletException, IOException {</p>  <p style='font: 11.0px Monaco'>    QueueConnectionFactory factory;</p>  <p style='font: 11.0px Monaco'>    Queue queue;</p>  <p style='font: 11.0px Monaco'><span style='color:#7f0055;'>    try</span> {</p>  <p style='font: 11.0px Monaco'>        Properties jndiProps = <span style='color:#7f0055;'>new</span> Properties();<span style='color:#000000;'/></p><p style='font: 11.0px Monaco'><span style='color:#000000;'>        jndiProps.setProperty(</span>"java.naming.provider.url"<span style='color:#000000;'>,</span> "jnp://localhost:1199"<span style='color:#000000;'>)</span></p>  <p style='font: 11.0px Monaco'>        InitialContext initialContext = <span style='color:#7f0055;'>new</span> InitialContext( jndiProps );</p><p style='font: 11.0px Monaco'>        factory = (QueueConnectionFactory) initialContext.lookup( <span style='color:#2a00ff;'>"/ConnectionFactory"</span> );</p>  <p style='font: 11.0px Monaco'>        queue = (Queue) initialContext.lookup( <span style='color:#2a00ff;'>"queue/hibernatesearch"</span> );</p>  <p style='font: 11.0px Monaco'>    }</p>  <p style='font: 11.0px Monaco'><span style='color:#7f0055;'>    catch</span> (NamingException e) {</p>  <p style='font: 11.0px Monaco; color:#2a00ff;'><span style='color:#7f0055;'>        throw</span> <span style='color:#7f0055;'>new</span> <span style='color:#000000;'>Exception(</span> "Unable to lookup queue"<span style='color:#000000;'>, e );</span></p>  <p style='font: 11.0px Monaco'>    }</p><p style='font: 11.0px Monaco'><br/></p>  <p style='font: 11.0px Monaco'>    QueueConnection cnn;</p>  <p style='font: 11.0px Monaco'>    QueueSender sender;</p>  <p style='font: 11.0px Monaco'>    QueueSession session;</p>  <p style='font: 11.0px Monaco'><span style='color:#7f0055;'>    try</span> {</p>  <p style='font: 11.0px Monaco'>        cnn = factory.createQueueConnection();</p>  <p style='font: 11.0px Monaco'>        session = cnn.createQueueSession( <span style='color:#7f0055;'>false</span>, QueueSession.AUTO_ACKNOWLEDGE );</p>  <p style='font: 11.0px Monaco'><br/></p><p style='font: 11.0px Monaco'>        TextMessage message = session.createTextMessage();</p>  <p style='font: 11.0px Monaco'>        message.setText(<span style='color:#2a00ff;'>"Pass it along"</span>);</p>  <p style='font: 11.0px Monaco'>        sender = session.createSender( queue );</p>  <p style='font: 11.0px Monaco'>        sender.send( message );</p>  <p style='font: 11.0px Monaco'>        session.close();</p>  <p style='font: 11.0px Monaco'>    }</p>  <p style='font: 11.0px Monaco'><span style='color:#7f0055;'>    catch</span> (JMSException e) {</p>  <p style='font: 11.0px Monaco; color:#2a00ff;'><span style='color:#7f0055;'>        throw</span> <span style='color:#7f0055;'>new</span> <span style='color:#000000;'>Exception(</span> "Unable to send message to JMS queue"<span style='color:#000000;'>, e );</span></p>  <p style='font: 11.0px Monaco'>    }</p>  <p style='font: 11.0px Monaco; color:#7f0055;'><span style='color:#000000;'><span style='color:#7F0055;'>    finally <span style='color:#000000;'>{</span></span></span></p>  <p style='font: 11.0px Monaco'><span style='color:#7f0055;'>        try</span> {</p>  <p style='font: 11.0px Monaco'><span style='color:#7f0055;'>            if</span> (cnn != <span style='color:#7f0055;'>null</span>) cnn.close();</p>  <p style='font: 11.0px Monaco'>        }</p>  <p style='font: 11.0px Monaco'><span style='color:#7f0055;'>        catch</span> ( JMSException e ) {</p>  <p style='font: 11.0px Monaco; color:#2a00ff;'><span style='color:#000000;'>            log.warn(</span> "Unable to close JMS connection"<span style='color:#000000;'>, e );</span></p>  <p style='font: 11.0px Monaco'>        }</p>  <p style='font: 11.0px Monaco'>    }</p>  <p style='font: 11.0px Monaco'>}</p></blockquote><p>A few things are noticeable here:</p><ul>  <li>we override the JNDI URL to point to the master JNDI host and port: if you run the master instance on a different machine (without remapping ports), the URL will look like <em>jnp://master.host:1099</em>.</li>  <li>to look up the factory we use <em>/ConnectionFactory</em>. Do not use <em>java:/ConnectionFactory</em> as this value points to your local instance (I lost a few hours here, thanks Clebert for the hand!). If you want to change this name, open deploy/messaging/connection-factories-service.xml and add a new binding under the <em>JNDIBindings</em> attribute.</li>  <li>always close your connection in a finally block to avoid connection leaks</li></ul><p>On the master side, you can deploy a MDB (a trivial task with EJB 3 as no deployment descriptor is needed).</p><blockquote>  <p style='font: 11.0px Monaco'><span style='color:#646464;'>@MessageDriven</span>(activationConfig = {</p>  <p style='font: 11.0px Monaco'><span style='color:#646464;'>    @ActivationConfigProperty</span>(propertyName=<span style='color:#2a00ff;'>"destinationType"</span>, propertyValue=<span style='color:#2a00ff;'>"javax.jms.Queue"</span>),</p>  <p style='font: 11.0px Monaco; color:#2a00ff;'><span style='color:#646464;'>    @ActivationConfigProperty</span><span style='color:#000000;'>(propertyName=</span>"destination"<span style='color:#000000;'>, propertyValue=</span>"queue/hibernatesearch"<span style='color:#000000;'>),</span></p>  <p style='font: 11.0px Monaco'><span style='color:#646464;'>    @ActivationConfigProperty</span>(propertyName=<span style='color:#2a00ff;'>"DLQMaxResent"</span>, propertyValue=<span style='color:#2a00ff;'>"1")</span></p>  <p style='font: 11.0px Monaco'>} )</p>  <p style='font: 11.0px Monaco'><span style='color:#7f0055;'>public</span> <span style='color:#7f0055;'>class</span> MDBPassOnController <span style='color:#7f0055;'>implements</span> MessageListener {</p>  <p style='font: 11.0px Monaco'><span style='color:#7f0055;'>    private</span> <span style='color:#7f0055;'>final</span> Logger log = LoggerFactory.getLogger( MDBPassOnController.<span style='color:#7f0055;'>class</span> );</p><br/><p style='font: 11.0px Monaco'><span style='color:#7f0055;'>    public</span> <span style='color:#7f0055;'>void</span> onMessage(Message message) {</p>  <p style='font: 11.0px Monaco'><span style='color:#7f0055;'>        if</span> ( !( message <span style='color:#7f0055;'>instanceof</span> TextMessage ) ) {</p>  <p style='font: 11.0px Monaco'>            log.error( <span style='color:#2a00ff;'>"Incorrect message type: {}"</span>, message.getClass() );</p>  <p style='font: 11.0px Monaco; color:#7f0055;'>            return<span style='color:#000000;'>;</span></p>  <p style='font: 11.0px Monaco'>        }</p>  <p style='font: 11.0px Monaco'>        TextMessage textMessage = (TextMessage) message;</p>  <p style='font: 11.0px Monaco'>        System.<span style='color:#0000c0;'>out</span>.println( textMessage.getText() );</p>  <p style='font: 11.0px Monaco'>    }</p>  <p style='font: 11.0px Monaco'>}</p></blockquote><p>The new embedded console (to come with JBoss AS 5 final) based on a stripped down version of <a href='http://www.jboss.com/products/jbosson'>JBoss ON</a> will make some of these steps much easier but now that you have gone the roots way, don't you feel stronger? :)</p>
